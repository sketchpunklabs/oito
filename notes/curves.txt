
// Rotation Minimizing Frame
// https://seth.rocks/projects/doublereflection/
// https://github.com/ialhashim/topo-blend/blob/master/TopoBlenderLib/RMF.h
// https://github.com/bzamecnik/gpg/blob/master/rotation-minimizing-frame/rmf.py
// https://github.com/GSharker/G-Shark/blob/69d2286e38b6d928298329646759e69e1776cfa2/src/GShark/ExtendedMethods/Curve.cs#L65
// https://www.microsoft.com/en-us/research/wp-content/uploads/2016/12/Computation-of-rotation-minimizing-frames.pdf
// https://github.com/GSharker/G-Shark/blob/69d2286e38b6d928298329646759e69e1776cfa2/src/GShark/ExtendedMethods/Curve.cs#L65
// https://forum.unity.com/threads/rotation-minimizing-frames-rmf-algorithm.1012387/
/// <summary>
        /// Creates rotation minimized perpendicular frames (RMF) at given t parameters along the curve.
        /// <para>//Double reflection method taken from Wang, W., JÂ¨uttler, B., Zheng, D., and Liu, Y. 2008. "Computation of rotation minimizing frame."  https://www.microsoft.com/en-us/research/wp-content/uploads/2016/12/Computation-of-rotation-minimizing-frames.pdf </para>
        /// </summary>
        ///<param name="curve">The input curve.</param>
        /// ///<param name="uValues">The curve parameter values to locate perpendicular curve frames</param>
        public static List<Plane> PerpendicularFrames(this ICurve curve, List<double> uValues)
        {
            var pointsOnCurve = uValues.Select(curve.PointAt).ToList(); //get points at t values
            var pointsOnCurveTan = uValues.Select(t => Evaluation.RationalCurveTangent(curve, t)).ToList(); //get tangents at t values
            var firstParameter = uValues[0]; //get first t value

            //Create initial frame at first parameter
            var origin = curve.PointAt(firstParameter);
            var crvTan = Evaluation.RationalCurveTangent(curve, firstParameter);
            var crvNormal = Vector3.PerpendicularTo(crvTan);
            var yAxis = Vector3.CrossProduct(crvTan, crvNormal);
            var xAxis = Vector3.CrossProduct(yAxis, crvTan);

            //Set initial frame
            Plane[] perpFrames = new Plane[pointsOnCurve.Count];
            perpFrames[0] = new Plane(origin, xAxis, yAxis);

            //Given boundary data(x0, t0; x1, t1) and an initial right-handed
            //orthonormal frame U0 = (r0, s0, t0) at x0, the next frame U1 = (r1, s1, t1)
            //at x1 for RMF approximation is computed by the double reflection method in
            //the following two steps.
            //
            //Step 1.Let R1 denote the reflection in the bisecting plane of the points x0
            //and x1(see Figure 4).Use R1 to map U0 to a left - handed orthonormal frame
            //UL0 = (rL0, sL0, tL0).
            //
            //Step 2.Let R2 denote the reflection in the bisecting plane of the points x1 + tL
            //0 and x1 +t1. Use R2 to map UL0 to a right - handed orthonormal frame U1 = (r1, s1, t1).
            //Output U1.

            for (int i = 0; i < pointsOnCurve.Count - 1; i++)
            {
                Vector3 v1 = pointsOnCurve[i + 1] - pointsOnCurve[i]; //compute reflection vector of R1
                double c1 = v1 * v1;
                Vector3 rLi = perpFrames[i].XAxis - (2 / c1) * (v1 * perpFrames[i].XAxis) * v1; //compute reflected rL vector by R1
                Vector3 tLi = pointsOnCurveTan[i] - (2 / c1) * (v1 * pointsOnCurveTan[i]) * v1; //compute reflected tL vector by R1
                Vector3 v2 = pointsOnCurveTan[i + 1] - tLi; //compute reflection vector of R2
                double c2 = v2 * v2;
                Vector3 rNext = rLi - (2 / c2) * (v2 * rLi) * v2; //compute reflected r vector by R2
                var sNext = Vector3.CrossProduct(pointsOnCurveTan[i + 1], rNext); //compute vector s[i+1] of next frame

                //create output frame
                var frameNext = new Plane();
                frameNext.Origin = pointsOnCurve[i + 1];
                frameNext.XAxis = rNext;
                frameNext.YAxis = sNext;
                perpFrames[i + 1] = frameNext; //output frame
            }

            return perpFrames.ToList();
        }
    }
}