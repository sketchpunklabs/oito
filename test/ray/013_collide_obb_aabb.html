<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title></title></head>
<style>canvas{ display:block; } body, html { padding:0px; margin:0px; width:100%; height:100%; }</style>
<body><script type="module">
// #region IMPORTS
import useThreeWebGL2, { THREE, useDarkScene, useVisualDebug } from '../_lib/useThreeWebGL2.js';
import useTransformControl  from '../_lib/useTransformControl.js';

import { Vec3, Quat } from '@oito/oop';
import { Obb, Aabb, overlap2OBB } from '@oito/ray';
// #endregion

// #region MAIN
let App   = useDarkScene( useThreeWebGL2() );
let Debug = {};
let Ref   = {
    obb   : new Obb(),
    box   : new Obb(), // new Aabb(),
    gizmo : useTransformControl( App ).useAxes(),
};

window.addEventListener( 'load', async _=>{
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup
    App.sphericalLook( 0, 20, 6 );
    Debug = await useVisualDebug( App );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    const q = new Quat().fromEuler( -45, 45, 0 );
    Ref.obb.fromQuat( q );
    Ref.obb.center.xyz( 1, 1, -1 );
    Ref.obb.extents.xyz( 0.5, 0.5, 0.5);

    // Ref.box.setBounds( [0,0,0], [1,1,1] );
    Ref.box.fromAABB( [0,0,0], [1,1,1] );

    Ref.gizmo.setPos( Ref.obb.center );

    debug();

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    App.renderLoop();
});

Ref.gizmo.onMove = p=>{
    Ref.obb.center.copy( p );
    debug();
};


function debug(){
    Debug.reset();

    const hit = overlap2OBB( Ref.obb, Ref.box );

    debugOBB( Ref.obb.center, Ref.obb.xAxis, Ref.obb.yAxis, Ref.obb.zAxis, Ref.obb.extents, 0x00ff00, false );
    
    debugOBB( Ref.box.center, Ref.box.xAxis, Ref.box.yAxis, Ref.box.zAxis, Ref.box.extents, (hit)?0xff0000:0x00ff00, false );
    // debugAABB( Ref.box.min, Ref.box.max, (hit)?0xff0000:0x00ff00, false );
}
// #endregion


// #region VISUAL DEBUG

function debugOBB( c, xx, yy, zz, h, col=0x00ff00, is_dash=false ){
    const x  = [ xx[0] * h[0], xx[1] * h[0], xx[2] * h[0] ];
    const y  = [ yy[0] * h[1], yy[1] * h[1], yy[2] * h[1] ];
    const z  = [ zz[0] * h[2], zz[1] * h[2], zz[2] * h[2] ];

    const ba = [ (c[0] - x[0] + y[0] - z[0]), (c[1] - x[1] + y[1] - z[1]), (c[2] - x[2] + y[2] - z[2]) ];
    const bb = [ (c[0] - x[0] - y[0] - z[0]), (c[1] - x[1] - y[1] - z[1]), (c[2] - x[2] - y[2] - z[2]) ];
    const bc = [ (c[0] + x[0] - y[0] - z[0]), (c[1] + x[1] - y[1] - z[1]), (c[2] + x[2] - y[2] - z[2]) ];
    const bd = [ (c[0] + x[0] + y[0] - z[0]), (c[1] + x[1] + y[1] - z[1]), (c[2] + x[2] + y[2] - z[2]) ];
    const fa = [ (c[0] - x[0] + y[0] + z[0]), (c[1] - x[1] + y[1] + z[1]), (c[2] - x[2] + y[2] + z[2]) ];
    const fb = [ (c[0] - x[0] - y[0] + z[0]), (c[1] - x[1] - y[1] + z[1]), (c[2] - x[2] - y[2] + z[2]) ];
    const fc = [ (c[0] + x[0] - y[0] + z[0]), (c[1] + x[1] - y[1] + z[1]), (c[2] + x[2] - y[2] + z[2]) ];
    const fd = [ (c[0] + x[0] + y[0] + z[0]), (c[1] + x[1] + y[1] + z[1]), (c[2] + x[2] + y[2] + z[2]) ];

    Debug.ln.add( ba, bb, col, null, is_dash ); // Back
    Debug.ln.add( bb, bc, col, null, is_dash );
    Debug.ln.add( bc, bd, col, null, is_dash );
    Debug.ln.add( bd, ba, col, null, is_dash );
    Debug.ln.add( fa, fb, col, null, is_dash ); // Front
    Debug.ln.add( fb, fc, col, null, is_dash );
    Debug.ln.add( fc, fd, col, null, is_dash );
    Debug.ln.add( fd, fa, col, null, is_dash );
    Debug.ln.add( fa, ba, col, null, is_dash ); // Connect
    Debug.ln.add( fb, bb, col, null, is_dash );
    Debug.ln.add( fc, bc, col, null, is_dash );
    Debug.ln.add( fd, bd, col, null, is_dash );
    return this
}

function debugAABB( min, max, col=0x00ff00, isDash=false ){
    const x1 = min[0], y1 = min[1], z1 = min[2];
    const x2 = max[0], y2 = max[1], z2 = max[2];

    const b0 = [x1,y1,z1];
    const b1 = [x1,y1,z2];
    const b2 = [x2,y1,z2];
    const b3 = [x2,y1,z1];

    const t0 = [x1,y2,z1];
    const t1 = [x1,y2,z2];
    const t2 = [x2,y2,z2];
    const t3 = [x2,y2,z1];

    Debug.ln.add( b0, b1, col, null, isDash );  // Bottom Face
    Debug.ln.add( b1, b2, col, null, isDash );
    Debug.ln.add( b2, b3, col, null, isDash );
    Debug.ln.add( b3, b0, col, null, isDash );

    Debug.ln.add( t0, t1, col, null, isDash );  // Top Face
    Debug.ln.add( t1, t2, col, null, isDash );
    Debug.ln.add( t2, t3, col, null, isDash );
    Debug.ln.add( t3, t0, col, null, isDash );

    Debug.ln.add( b0, t0, col, null, isDash );  // Sides
    Debug.ln.add( b1, t1, col, null, isDash );
    Debug.ln.add( b2, t2, col, null, isDash );
    Debug.ln.add( b3, t3, col, null, isDash );
}

// #endregion


</script></body></html>