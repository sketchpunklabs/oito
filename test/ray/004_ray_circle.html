<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title></title></head>
<style>canvas{ display:block; } body, html { padding:0px; margin:0px; width:100%; height:100%; }</style>
<body><script type="module">
//#region IMPORTS
import useThreeWebGL2, { THREE, useDarkScene, useVisualDebug } from '../_lib/useThreeWebGL2.js';

import { Vec3 }                 from '@oito/oop';
import { Ray, intersectCircle } from '@oito/ray';
//#endregion

//#region MAIN
let App   = useDarkScene( useThreeWebGL2() );
let Debug = {};
let Ref   = {
    pos     : [0,1,0],
    radius  : 0.5, 
    xAxis   : new Vec3(),
    yAxis   : new Vec3(),
    norm    : new Vec3(),
};

window.addEventListener( 'load', async _=>{
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup
    App.sphericalLook( 0, 20, 6 );
    Debug = await useVisualDebug( App );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    
    Ref.xAxis.fromNorm(  [ -0.5, 0.5, -0.5 ] );
    Ref.yAxis.fromCross( Ref.xAxis, [0,1,0] ).norm();
    Ref.norm.fromCross( Ref.yAxis, Ref.xAxis ).norm();
    
    Debug.pnt.add( Ref.pos, 0x00ff00, 2 );
    Debug.ln.add( Ref.pos, new Vec3().fromScaleThenAdd( Ref.radius, Ref.xAxis, Ref.pos ), 0x00ff00, null, true );
    Debug.ln.add( Ref.pos, new Vec3().fromScaleThenAdd( Ref.radius, Ref.yAxis, Ref.pos ), 0x00ff00, null, true );
    Debug.ln.add( Ref.pos, new Vec3().fromScaleThenAdd( Ref.radius, Ref.norm, Ref.pos ), 0x00ff00, null, true );

    Debug.ln.circle( Ref.pos, Ref.xAxis, Ref.yAxis, Ref.radius, 12, 0x00ff00, true );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    App.renderLoop();
});
//#endregion

window.addEventListener( 'pointerdown', e=>{
    if( e.button != 2 ) return;

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Compute the Ray and visually draw a line
    const ray = from3JSScreenProjection( new Ray(), e.layerX, e.layerY );
    Debug.ln.add( ray.posStart, ray.posEnd, 0x00ffff );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    const t = intersectCircle( ray, Ref.radius, Ref.pos, Ref.norm ); 
    if( t != null ){
        Debug.pnt.add( ray.posAt( t ), 0x00ffff, 4 );
    }
} );

function from3JSScreenProjection( ray, xMouse, yMouse ){
    const size      = new THREE.Vector2();
    const proj      = App.camera.projectionMatrix.toArray();    // Need Projection Matrix
    const camWorld  = App.camera.matrixWorld.toArray();         // World Space Transform of Camera
    App.renderer.getSize( size );                               // Need Size of Canvas

    // Setup Ray
    ray.fromScreenProjection( xMouse, yMouse, size.x, size.y, proj, camWorld );
    return ray;
}

</script></body></html>